### 
### DO NOT MODIFY THIS FILE!
### 
### This YAML was auto-generated from PublishPipeline.cs
### To make changes, change the C# definition and rebuild its project
### 

jobs:
- job: Publish
  displayName: Publish to nuget.org
  pool:
    vmImage: windows-latest
    name: Azure Pipelines
  steps:
  - powershell: |+
      $tag = git tag --points-at HEAD
      if ("" -eq "$tag") {
        Write-Host '##vso[task.complete result=Failed;]No git tag with version found'
        exit 1
      }

      $versions = $tag.Split('.')

      $major = $versions[0]
      $minor = $versions[1]
      $patch = $versions[2]

      Write-Host "##vso[task.setvariable variable=majorVersion]$major"
      Write-Host "##vso[task.setvariable variable=minorVersion]$minor"
      Write-Host "##vso[task.setvariable variable=patchVersion]$patch"
    displayName: Detect package version

  - task: UseDotNet@2
    displayName: Install .NET 6 preview 3
    inputs:
      packageType: sdk
      version: 6.0.100-preview.3.21202.5

  - powershell: |-
      New-Item -Path 'artifacts' -Name 'packages' -ItemType 'directory'

  - task: DotNetCoreCLI@2
    displayName: Build Sharpliner.csproj
    inputs:
      command: build
      includeNuGetOrg: true
      projects: src/Sharpliner/Sharpliner.csproj
      arguments: -c Release

  - task: NuGetCommand@2
    displayName: Pack the .nupkg
    inputs:
      command: pack
      includeNuGetOrg: true
      packagesToPack: src/Sharpliner/Sharpliner.csproj
      versioningScheme: byPrereleaseNumber
      majorVersion: $(majorVersion)
      minorVersion: $(minorVersion)
      patchVersion: $(patchVersion)
      configuration: Release

  - ${{ if and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranch'], 'refs/heads/main')) }}:
    - task: NuGetAuthenticate@0
      displayName: Authenticate NuGet

    - task: NuGetCommand@2
      displayName: Publish to nuget.org
      inputs:
        command: push
        packagesToPush: artifacts/packages/Sharpliner*.nupkg
        nuGetFeedType: external
        publishFeedCredentials: Sharpliner / nuget.org
